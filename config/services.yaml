# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Entity/'
            - '../src/Kernel.php'

    # add more service definitions when explicit configuration is needed
    # please note that last definitions always *replace* previous ones

    App\Shared\Presentation\Security\ApiKeyAuthenticator:
        arguments:
            $apiKey: '%env(API_KEY)%'

    # Redis Configuration
    Predis\ClientInterface:
        class: Predis\Client
        arguments:
            $parameters: '%env(REDIS_URL)%'

    redis.client:
        alias: Predis\ClientInterface

    App\Product\Infrastructure\Api\CompetitorApiFactory:
        arguments:
            $competitorApis: !tagged_iterator app.competitor_api
            
    App\Product\Infrastructure\Api\ExternalApiInterface:
        tags: ['app.competitor_api']

    App\Product\Application\Service\CompetitorPriceService:
        arguments:
            $apiFactory: '@App\Product\Infrastructure\Api\CompetitorApiFactory'
            $defaultProductIdsService: '@App\Product\Application\Service\DefaultProductIdsService'

    App\Product\Infrastructure\Api\CompetitorApi1:
        tags: ['app.competitor_api']

    App\Product\Infrastructure\Api\CompetitorApi2:
        tags: ['app.competitor_api']

    App\Product\Infrastructure\Api\CompetitorApi3:
        tags: ['app.competitor_api']


      # Strategy Interface Aliases
    App\Product\Domain\Service\Strategy\PriceAggregationStrategyInterface:
        alias: App\Product\Domain\Service\Strategy\AveragePriceAggregationStrategy

    # Cache Services
    App\Product\Infrastructure\Cache\ProductPriceCacheService:
        arguments:
            $cache: '@App\Shared\Infrastructure\Cache\RedisCache'

    # Cached Use Cases
    App\Product\Application\UseCase\CachedGetAllProductPricesUseCase:
        arguments:
            $repository: '@App\Product\Domain\Repository\ProductPriceRepositoryInterface'
            $cacheService: '@App\Product\Infrastructure\Cache\ProductPriceCacheService'

    App\Product\Application\UseCase\CachedGetProductPriceByIdUseCase:
        arguments:
            $repository: '@App\Product\Domain\Repository\ProductPriceRepositoryInterface'
            $cacheService: '@App\Product\Infrastructure\Cache\ProductPriceCacheService'

    App\Product\Domain\Repository\ProductPriceRepositoryInterface: '@App\Product\Infrastructure\Repository\ProductPriceRepository'

    App\Shared\Infrastructure\Cache\CacheInterface: '@App\Shared\Infrastructure\Cache\RedisCache'

    App\Shared\Infrastructure\Cache\RedisCache:
        arguments:
            $redis: '@redis.client'

    App\Product\Application\UseCase\FetchCompetitorPricesUseCase:
        arguments:
            $competitorPriceService: '@App\Product\Application\Service\CompetitorPriceService'

    App\Product\Application\MessageHandler\FetchPricesMessageHandler:
        arguments:
            $fetchUseCase: '@App\Product\Application\UseCase\FetchCompetitorPricesUseCase'
            $repository: '@App\Product\Domain\Repository\ProductPriceRepositoryInterface'

    App\Product\Application\Service\ProductPriceApiService:
        arguments:
            $getAllUseCase: '@App\Product\Application\UseCase\CachedGetAllProductPricesUseCase'
            $getByIdUseCase: '@App\Product\Application\UseCase\CachedGetProductPriceByIdUseCase'
            $validator: '@validator'

    App\Product\Application\Service\ProductPriceErrorHandler:
        # No arguments needed